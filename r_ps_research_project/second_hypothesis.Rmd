---
title: 'P&S-2022: Reasearch Project - second hypothesis'
author: "Matsyshyn Serhii, Ivanov Serhii"
output:
  html_document:
    df_print: paged
---

```{r}
# install.packages("PHEindicatormethods")
install.packages("dplyr")
```

```{r}
# library(PHEindicatormethods)
source("r_libraries/phe_life_expectancy.r")

library(dplyr)
```

## Hypothesis (2): The growth of the urban population has affected the average life expectancy of the population.
Task: to test this hypothesis on the example of one country.
Parameters that will be analyzed: indicators of the place of residence (rural area/urban area); average life expectancy.
Research directions: analysis of changes in the urban population over time;
analysis of changes in average life expectancy over time; to compare the
dependence between time changes of the investigated indicators; trace the linear
relationship between these characteristics (linear regression analysis);
visualization of research data.  

We have chosen Finland to test this hypothesis.
```{r}
# csv file reading
database_filename <- "final_datasets/Finland_combined__years_with_nan_dropped_True_born_sum.csv"
database <- read.csv(database_filename, header = TRUE, sep = ",")
```

```{r}
# print first 50 rows
head(database, 100)
```

The data present in dataset for Finland is from 1966 to 2021 years.  
```{r}
years_list <- unique(database$Year)
years_list
```

## Life expectancy
We will use "life expectancy at birth" indicator.  
It is calculated as the average number of years a born child would live if prevailing patterns of mortality at the time of birth were to stay the same throughout the life.  
We will use "life expectancy at birth" since it is the most commonly used measure of an average life expectancy of a population.  
We will use library PHEindicatormethods (https://cran.r-project.org/web/packages/PHEindicatormethods/index.html) to calculate life expectancy. It was slightly modified to work with our data (to accept 0-4 years group, which is suitable in our case).  

```{r}
# save life expectancy for each year in a dataframe
life_expectancy_df <- data.frame(Year = years_list, Life_expectancy = rep(NA, length(years_list)))

# iterate over each year in Year column
for (year in years_list) {
    current_year_data <- database[database$Year == year, ]

    # sum up Values and Deaths for each age group based on year
    current_year_data_summarized <- current_year_data %>%
        group_by(Age) %>%
        summarise(Value = sum(Value), Deaths = sum(Deaths))

    # print(current_year_data_summarized)

    life_expectancy <- phe_life_expectancy(
        data = current_year_data_summarized,
        deaths = Deaths,
        population = Value,
        startage = Age,
        age_contents = c(
            "0 - 4", "5 - 9",
            "10 - 14", "15 - 19",
            "20 - 24", "25 - 29",
            "30 - 34", "35 - 39",
            "40 - 44", "45 - 49",
            "50 - 54", "55 - 59",
            "60 - 64", "65 - 69",
            "70 - 74", "75 - 79",
            "80 +"
        ),
        le_age = "0 - 4",
        type = "full",
        confidence = 0.95
    )
    life_expectancy_df[life_expectancy_df$Year == year, "Life_expectancy"] <- life_expectancy$value
}
```

We calculated life expectancy for each year.
```{r}
# print life expectancy for each year
life_expectancy_df
```

```{r}
# plot life expectancy for each year
plot(life_expectancy_df$Year, life_expectancy_df$Life_expectancy,
    type = "l",
    xlab = "Year",
    ylab = "Life expectancy",
    main = "Life expectancy in Finland",
    col = "blue",
    lwd = 2,
)
```
We can see that life expectancy in Finland has been growing over the years.

Now let's see how life expectancy has changed in rural and urban areas.
```{r}
# save life expectancy for each year in a dataframe
life_expectancy_rural_urban_df <- data.frame(Year = years_list, Life_expectancy = rep(NA, length(years_list)))

# iterate over each year in Year column
for (year in years_list) {
    current_year_data <- database[database$Year == year, ]

    # sum up Values and Deaths for each age group based on year and only rural areas
    current_year_data_summarized_rural <- current_year_data %>%
        filter(Area == "Rural") %>%
        group_by(Age) %>%
        summarise(Value = sum(Value), Deaths = sum(Deaths))

    # sum up Values and Deaths for each age group based on year and only urban areas
    current_year_data_summarized_urban <- current_year_data %>%
        filter(Area == "Urban") %>%
        group_by(Age) %>%
        summarise(Value = sum(Value), Deaths = sum(Deaths))

    # print(current_year_data_summarized)

    life_expectancy_rural <- phe_life_expectancy(
        data = current_year_data_summarized_rural,
        deaths = Deaths,
        population = Value,
        startage = Age,
        age_contents = c(
            "0 - 4", "5 - 9",
            "10 - 14", "15 - 19",
            "20 - 24", "25 - 29",
            "30 - 34", "35 - 39",
            "40 - 44", "45 - 49",
            "50 - 54", "55 - 59",
            "60 - 64", "65 - 69",
            "70 - 74", "75 - 79",
            "80 +"
        ),
        le_age = "0 - 4",
        type = "full",
        confidence = 0.95
    )

    life_expectancy_urban <- phe_life_expectancy(
        data = current_year_data_summarized_urban,
        deaths = Deaths,
        population = Value,
        startage = Age,
        age_contents = c(
            "0 - 4", "5 - 9",
            "10 - 14", "15 - 19",
            "20 - 24", "25 - 29",
            "30 - 34", "35 - 39",
            "40 - 44", "45 - 49",
            "50 - 54", "55 - 59",
            "60 - 64", "65 - 69",
            "70 - 74", "75 - 79",
            "80 +"
        ),
        le_age = "0 - 4",
        type = "full",
        confidence = 0.95
    )

    life_expectancy_rural_urban_df[life_expectancy_rural_urban_df$Year == year, "Life_expectancy_rural"] <- life_expectancy_rural$value
    life_expectancy_rural_urban_df[life_expectancy_rural_urban_df$Year == year, "Life_expectancy_urban"] <- life_expectancy_urban$value
}
```

```{r}
life_expectancy_rural_urban_df
```

```{r}
# plot life expectancy for rural and urban areas
plot(life_expectancy_rural_urban_df$Year,
    life_expectancy_rural_urban_df$Life_expectancy_rural,
    type = "l",
    xlab = "Year",
    ylab = "Life expectancy",
    main = "Life expectancy in rural and urban areas in Finland",
    col = "blue",
    lwd = 2,
)
par(new = TRUE)
plot(life_expectancy_rural_urban_df$Year,
    life_expectancy_rural_urban_df$Life_expectancy_urban,
    type = "l",
    col = "red",
    axes = FALSE, xlab = "", ylab = "",
    lwd = 2
)
axis(
    side = 4,
    at = pretty(range(life_expectancy_rural_urban_df$Life_expectancy_rural)),
)
mtext("%", side = 4, line = 1)

legend("topleft",
    legend = c("Life expectancy in rural areas", "Life expectancy in urban areas"),
    col = c("blue", "red"), lty = 1, cex = 0.8
)
```

## First short test to check, how data can be analysed further

First of all, let us look at the life expectancy in rural and urban areas side by side.  
We can use T-test to determine whether there is a significant difference in the mean life expectancy between urban and rural populations.
```{r}
t.test(life_expectancy_rural_urban_df$Life_expectancy_urban, life_expectancy_rural_urban_df$Life_expectancy_rural)
```

Based on the output of the t-test, it appears that there is no statistically significant difference in the mean life expectancy between the rural and urban populations at a given point in time.  
This is indicated by the p-value of 0.5395, which is greater than the commonly used significance level of 0.05.  
This means that there is not enough evidence to reject the null hypothesis, which states that there is no difference in the means of the two groups.

The t-test also provides a 95% confidence interval for the difference in the means, which is (-1.11677, 2.11637).  
This interval indicates that there is a 95% chance that the true difference in the means falls within this range.  
It is also worth noting that the t-statistic of 0.61663 is relatively small, which suggests that there is not a strong difference in the means of the two groups.  

Overall, the results of the t-test suggest that there is no significant difference in the mean life expectancy between the rural and urban populations at a given point in time.

#### Short summary of the first test
At the moment our analysis does not have any contradictions with our main hypothesis (the growth of the urban population has affected the average life expectancy of the population),
since the mean life expectancy in rural and urban areas is not significantly different at any given point in time.  

So we can use average life expectancy of whole population as a reference point for further analysis.

## Urban population growth
Now we calculate the percentage of urban population in Finland for each year.
```{r}
# save urban population percentage for each year in a dataframe
urban_population_df <- data.frame(Year = years_list, Urban_population = rep(NA, length(years_list)))

# iterate over each year in Year column
for (year in years_list) {
    current_year_data <- database[database$Year == year, ]

    # sum up Values and Deaths for each age group based on year
    current_year_data_summarized <- current_year_data %>%
        group_by(Area) %>%
        summarise(Value = sum(Value))

    # print(current_year_data_summarized)

    urban_population <- current_year_data_summarized[current_year_data_summarized$Area == "Urban", "Value"]
    rural_population <- current_year_data_summarized[current_year_data_summarized$Area == "Rural", "Value"]

    urban_population_df[urban_population_df$Year == year, "Urban_population"] <- (urban_population / (urban_population + rural_population)) * 100
}
```

```{r}
# print urban population percentage for each year
urban_population_df
```

```{r}
# plot urban population percentage for each year
plot(urban_population_df$Year, urban_population_df$Urban_population,
    type = "l",
    xlab = "Year",
    ylab = "Urban population percentage",
    main = "Urban population percentage in Finland",
    col = "blue",
    lwd = 2,
)
```

We can see that urban population percentage in Finland has been growing over the years.

Now we will plot life expectancy and urban population percentage on the same graph.
```{r}
plot(life_expectancy_df$Year,
    life_expectancy_df$Life_expectancy,
    type = "l",
    xlab = "Year",
    ylab = "Life expectancy",
    main = "Life expectancy and urban population percentage in Finland",
    col = "blue",
    lwd = 2,
)
par(new = TRUE)
plot(urban_population_df$Year,
    urban_population_df$Urban_population,
    type = "l",
    col = "red",
    axes = FALSE, xlab = "", ylab = ""
)
axis(
    side = 4,
    at = pretty(range(urban_population_df$Urban_population)),
)
mtext("%", side = 4, line = 1)

legend("topleft",
    legend = c("Life expectancy", "Urban population percentage"),
    col = c("blue", "red"), lty = 1, cex = 0.8
)
```

## Correlation between life expectancy and urban population percentage
Now we will calculate the correlation between life expectancy and urban population percentage.
```{r}
cor(life_expectancy_df$Life_expectancy, urban_population_df$Urban_population)
```

Since the correlation is positive, we can conclude that urban population percentage and life expectancy are positively correlated.
It has value of 0.866, which means that there is a strong positive correlation between life expectancy and urban population percentage.

## Linear regression analysis
Now we will apply linear regression analysis: it can be used to examine the relationship
between the growth of the urban population and the average life expectancy over time.

```{r}
# linear regression analysis
lm_model <- lm(life_expectancy_df$Life_expectancy ~ urban_population_df$Urban_population)
summary(lm_model)
```

Now we will plot the linear regression model.
```{r}
plot(urban_population_df$Urban_population,
    life_expectancy_df$Life_expectancy,
    xlab = "Urban population percentage",
    ylab = "Life expectancy",
    main = "Linear regression model",
    col = "blue",
    lwd = 2,
)
abline(lm_model, col = "green", lwd = 2)
legend("topleft",
    legend = c("Linear regression model"),
    col = c("green"), lty = 1, cex = 0.8
)
```

#### Summary of results of linear regression analysis
Results of linear regression analysis indicate that there is a positive relationship between urban population and life expectancy over time.  
This is suggested by the positive coefficient of 0.54 for urban population in the model. 

The model also has a high degree of fit, as indicated by the high R-squared value of 0.75.  
This means that 75% of the variance in life expectancy can be explained by urban population. 
The adjusted R-squared value is a modified version of R-squared that takes into account the number of variables in the model.  
In this case, the adjusted R-squared value is slightly lower than the R-squared value, at 0.7429.  
This suggests that some of the improvement in fit due to the inclusion of the urban population variable may be due to chance, rather than a true relationship.

The p-value for the urban population coefficient is very small (8.9e-12), which indicates that the relationship between urban population and life expectancy is statistically significant at a very high level of confidence. In other words, it is very unlikely that this relationship is due to chance.
Overall, these results support the hypothesis that there is a relationship between the growth of the urban population and the average life expectancy over time.  
This relationship is positive, meaning that as urban population increases, life expectancy tends to increase as well.

## Limitations of the analysis
It is important to note that the results of this analysis do not necessarily mean that urbanization causes increased life expectancy.  
There may be other factors that are correlated with both urbanization and life expectancy, and it is possible that these factors are driving the relationship that was observed in the data.  
For example, it is possible that increase in urban population is correlated with increased access to healthcare (more clinics are created in urban areas and they become more affordable, etc.), which in turn is correlated with increased life expectancy for both, urban and rural populations.  

But in any case, the results of this analysis suggest that there is a positive relationship between urban population rise and life expectancy over time.
